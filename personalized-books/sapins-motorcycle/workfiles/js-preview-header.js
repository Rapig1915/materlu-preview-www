<!-- JSON-LD markup generated by Google Structured Data Markup Helper. -->
<script type="application/ld+json">
{
  "@context" : "https://schema.org",
  "@type" : "Product",
  "name" : "<<(materbooks.data.==(language)==[?].title)>>",
  "image" : "<<(materbooks.data.==(language)==[?].cover.front)>>",
  "description" : "<<(materbooks.data.==(language)==[?].description)>>",
  "url" : "https://materlu.com/==(language)==/==(MAT_url_custom-stories)==/<<(materbooks.data.==(language)==[?].seo_url)>>",
  "brand" : {
	"@type" : "Brand",
	"name" : "Materlu",
	"logo" : "https://cdn.materlu.com/img/materlu_logo.png"
  },
  "offers" : {
	"@type" : "Offer",
	"availability": "http://schema.org/InStock",
	"price" : "<<(materbooks.data.==(language)==[?].price)>>.00",
	"priceCurrency" : "<<(materbooks.data.==(language)==[?].currency)>>"
  }
}
</script>
<script>
	var thisbook = <<(materbooks.data.==(language)==[?].id)>>
	var currentPage = 1;
	var amount = books["b"+thisbook].page_count;
	var lang = '==(language)==';
	var lettertype = 'standard';
	var version = 'Ant.ChkLater.v13:20';
	var blockPages = 2;
	var lastRequest = 0;
	var defaultDedication = "==(MAT_txt_dedication_helper2)==";
</script>
<script>
isEmpty = (obj) => {
	for(var key in obj) {
		if(obj.hasOwnProperty(key))
			return false;
	}
	return true;
}
if( isEmpty(currentBook()) ) window.location.assign(".");

function currentPreview(){
	try {
		var currentB = JSON.parse( loadSession("currentPreview") );
		if( Object.keys(currentB).length == 0 ){
			throw "Empty";
		}
		return currentB;
	}catch(e){	
		return {};
	}
}
function setcurrentPreview(preview){
	try {
		saveSession("currentPreview",JSON.stringify(preview),'local',1);
	}catch(e){
		return false;
	}
	return true;
}
function resetBook(){
console.log("RESETBOOK");
	setcurrentPreview();
	$(".pages").turn("destroy");
	$(".pages").removeClass("pagesLoaded");
	$(".page").remove();
	for(var i=1;i<(amount-1);i++){
		if(i==2) continue;
		$(".pages").append('<div class="singlePage previewPage" id="page'+i+'"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mO82g4AAjcBXq8Qp6oAAAAASUVORK5CYII=" class="img-fluid"><div class="gradient"><svg width="120" height="30" viewBox="0 0 120 30" xmlns="http://www.w3.org/2000/svg" fill="#40a1f1"><circle cx="15" cy="15" r="15"><animate attributeName="r" from="15" to="15"begin="0s" dur="0.8s"values="15;9;15" calcMode="linear"repeatCount="indefinite" /><animate attributeName="fill-opacity" from="1" to="1"begin="0s" dur="0.8s"values="1;.5;1" calcMode="linear"repeatCount="indefinite" /></circle><circle cx="60" cy="15" r="9" fill-opacity="0.3"><animate attributeName="r" from="9" to="9"begin="0s" dur="0.8s"values="9;15;9" calcMode="linear"repeatCount="indefinite" /><animate attributeName="fill-opacity" from="0.5" to="0.5"begin="0s" dur="0.8s"values=".5;1;.5" calcMode="linear"repeatCount="indefinite" /></circle><circle cx="105" cy="15" r="15"><animate attributeName="r" from="15" to="15"begin="0s" dur="0.8s"values="15;9;15" calcMode="linear"repeatCount="indefinite" /><animate attributeName="fill-opacity" from="1" to="1"begin="0s" dur="0.8s"values="1;.5;1" calcMode="linear"repeatCount="indefinite" /></circle></svg></div></div>');
	}
	$(".previewPage:first").addClass("hard");
	$(".previewPage:first").next().addClass("hard");
	$(".previewPage:last").addClass("hard");
	$(".previewPage:last").prev().addClass("hard");

	getNewRequest(1);
	
	$('.pages').turn({
		duration: 1500,
		acceleration: true,
		autoCenter: true,
		gradients: true,
		turnCorners: "bl,br",
		elevation: 300
	});

	$(".opa").removeClass("opa");
	$('.gradient').html("");
	$(".pages").addClass("pagesLoaded");

}
function start(){
	<!-- >> Katerina work from dedication -->
    var currentB = currentBook();
    if(!isEmpty(currentB)){
		if( currentB.language == undefined ) currentB.language = "==(language)==";
		switch( currentB.language ){
			case 'en': text='English';		src="==(MAT_cdn_books)==uploads/united-states.svg";  lang='en'; break;
			case 'es': text='Español';		src="==(MAT_cdn_books)==uploads/spain.svg";          lang='es'; break;
			case 'fr': text='French';		src="==(MAT_cdn_books)==uploads/france.svg";         lang='fr'; break;
			case 'it': text='Italian';		src="==(MAT_cdn_books)==uploads/italy.svg";          lang='it'; break;
			case 'de': text='German';		src="==(MAT_cdn_books)==uploads/germany.svg";        lang='de'; break;
//			case 'pt': text='Portuguese';	src="==(MAT_cdn_books)==uploads/portugal.svg";       lang='pt'; break;
			default:  text='English';		src="==(MAT_cdn_books)==uploads/united-states.svg";  lang='en';
		}
		$("#choose-language").find(".storySettings_language").html('<img src="'+src+'" class="country_icon mr-3" alt="country icon"> '+text);

		if( currentB.font_style != null && currentB.font_style != undefined ){
			var letterText = $("[value='"+currentB.font_style+"']").parent().text();
			$("#choose-letter-type").find(".storySettings_language").text(letterText);
		}
    }
	<!-- >> Katerina work -->
}
var shown = 0;
function resizeFrame(){
	var w = $('#main').width();
	if(w<=575.98){
		$('.pages').turn('size', '300', '150');
		if( shown == 0 ){
			$('#modal-phone-alert').modal('show');
			shown = 1;
		}
	}else{
		$('.pages').turn('size', '', '');
		$('#modal-phone-alert').modal('hide');   
	}
}
function parseDedication( text ){
	var res = text.split(" ");
	var parrafo = [];
	var part = "";
	$.each( res, function( index, value ){
		//console.log("PART: "+part.length );
		//console.log("VALUE: "+value.length );
		if( part.length + value.length + 1 > 31 ){
			parrafo.push( part + "\n" );
			part = value;
		}else{
			part = part + " " + value;
		}
	});
	parrafo.push( part );
	var result = parrafo.join("");
	result = result.trim();
	return result;
}
function addToCart(){
	console.log("Added to cart");
	var curB = currentBook();
	curB.font_style = lettertype;
	curB.language = lang;
	try {
		var cart = JSON.parse( loadSession("cart") );
		if( Object.keys(cart).length == 0 ){
			throw "Empty";
		}
	}catch(e){	
		console.log("New cart");
		var cart = {"books":[]};
	}

	curB.dedication = parseDedication( curB.dedication );
	curB.res = {
//		"cover": $("#page1").find("img").attr("src"),
		"title": "<<(materbooks.data.==(language)==[?].title)>>",
		"price": "<<(materbooks.data.==(language)==[?].price)>>",
		"currency": "EUR",
		"symbol": "€",
		"characters": []
	};
	for( var i=0;i<curB.characters.length;i++){
		var model =	{
			"name": curB.characters[i].name,
			"img": curB.characters[i].src
		}
		delete curB.characters[i].src;
		curB.res.characters.push(model);
	}
	
	try {
		cart.books.push( curB );
		saveSession("cart",JSON.stringify(cart),'local',1);

// Pinterest Pixel:
pintrk('track', 'addtocart', {
value: <<(materbooks.data.==(language)==[?].price)>>,
order_quantity: 1,
currency: 'EUR'
});
// FB Pixel
fbq('track', 'AddToCart');

	}catch(e){
		console.log(e);
		return false;
	}
	return cart;
}

</script>
<script>
function loadPage(pagefrom,pageto,next=0,forced=0){
//console.log("** LOADPAGE: " + pagefrom+","+pageto+","+next+","+forced);
	if( currentBook().code == undefined){
		console.log("REQUEST CANCELED");
		return false;
	}
	if( currentBook().code == lastRequest || lastRequest == 0 ){
		if( pagefrom > amount ) return;
		if( pageto > amount ){
			pageto = amount; 
			next = 0;
		}
		$.ajax({
			url: "https://admin.materlu.com/api/get-book-pages?",
			type: "GET",
			data: {
				"code": currentBook().code,
				"from": pagefrom,
				"to": pageto,
				"preview": 1
			},
			success: function(res){
				console.log("LOADED: "+pagefrom+"-"+pageto);
				var currentP = currentPreview();
				for(var i=0;i<res.pages.length;i++){
					var ind = pagefrom+i;
					currentP["page"+ind] = res.pages[i];
					if( ind < amount ){
						if( ind > 2 ) ind = ind-1;
						addPages(ind,res.pages[i]);
					}
				}
				setcurrentPreview(currentP);
				if(next>0){
					loadPage(pageto+1, pageto+next+1, next);
				}
			},
			error: function(error){
				console.log("GET PAGES FAILED: "+pagefrom+" - "+pageto);
				console.log(error);
			}
		});
	}else{
		console.log("REQUEST CANCELED");
	}
}
function checkPages(page=0){
	var currentP = currentPreview();
	var index = page;
	if(page > 1) index = page + 1;
//console.log("** CHECKPAGES: " + page +","+index);
//console.log(currentP['page'+index]);
	$(".pages").turn('addPage', '<div class="singlePage previewPage" id="page'+index+'"><img src="https://admin.materlu.com'+currentP['page'+index]+'" class="img-fluid"><div class="gradient"></div></div>', page);
}
function addPages(page,file){
	var index = page;
	if(page > 1) index = page + 1;
//console.log("** ADDPAGES: " + page +","+index);
//$(".pages").data();
	$(".pages").turn('addPage', '<div class="singlePage previewPage" id="page'+index+'"><img src="https://admin.materlu.com'+file+'" class="img-fluid"><div class="gradient"></div></div>', page);
}
function getNewRequest(start=0,restart=0){
console.log("** GETNEWREQUEST: " + start);
	var result = "";
	var curB = currentBook();
	for(var i=0;i<curB.characters.length;i++){
		delete curB.characters[i].src;
	}
	if( curB.font_style == undefined) curB.font_style = "standard";
	if( curB.language == undefined) curB.language = lang;
	if( curB.photo == undefined) curB.photo = "";
	var dataSub = {
        "storyId": curB.storyId,
        "language": curB.language,
        "font_style": curB.font_style,
        "characters": JSON.stringify(curB.characters),
        "photo": curB.photo
	};
	var thisDedication = curB.dedication;
	if( thisDedication == undefined || thisDedication == "" ){
		thisDedication = defaultDedication;
	}
	dataSub.dedication = parseDedication(thisDedication);
	if( curB.code != undefined) dataSub.code = curB.code;
	var currentP = currentPreview();
	$.ajax({
		url: "https://admin.materlu.com/api/save-preview-story?",
		type: "POST",
		data: dataSub,
		success: function(res){
			console.log(res)
			lastRequest = res.code;
			var result = addTocurrentBook( { "code": res.code } );
			if( start == 1 ){
				loadPage(1,1,0,0);
				loadPage(3,3+blockPages,blockPages,0);
			}else if( start > 1 ){
				loadPage(start,start,blockPages,0);
			}
			if( restart == 1 ){
				setTimeout(function(){ window.location.reload(); }, 1200);
			}
		},
		error: function(error){
			console.log("NEW REQUEST FAILED");
			console.log(error);
		}
	});
}
</script>