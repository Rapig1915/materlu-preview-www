<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.css" integrity="sha256-UK1EiopXIL+KVhfbFa8xrmAWPeBjMVdvYMYkTAEv/HI=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick-theme.min.css" integrity="sha256-4hqlsNP9KM6+2eA8VUT0kk4RsMRTeS7QGHIM+MZ5sLY=" crossorigin="anonymous" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.js" integrity="sha256-DHF4zGyjT7GOMPBwpeehwoey18z8uiz98G4PRu2lV0A=" crossorigin="anonymous"></script>
<!-- JSON-LD markup generated by Google Structured Data Markup Helper. -->
<script type="application/ld+json">
{
  "@context" : "https://schema.org",
  "@type" : "Product",
  "name" : "<<(materbooks.data.==(language)==[?].title)>>",
  "image" : "<<(materbooks.data.==(language)==[?].cover.front)>>",
  "description" : "<<(materbooks.data.==(language)==[?].description)>>",
  "url" : "https://materlu.com/==(language)==/==(MAT_url_custom-stories)==/<<(materbooks.data.==(language)==[?].seo_url)>>",
  "brand" : {
	"@type" : "Brand",
	"name" : "Materlu",
	"logo" : "https://cdn.materlu.com/img/materlu_logo.png"
  },
  "offers" : {
	"@type" : "Offer",
	"availability": "http://schema.org/InStock",
	"price" : "<<(materbooks.data.==(language)==[?].price)>>.00",
	"priceCurrency" : "<<(materbooks.data.==(language)==[?].currency)>>"
  }
}
</script>

<script src="==(MAT_cdn2)==default/defaults.js"></script>
<script>
	var defaultModel = defaultModel['b<<(materbooks.data.==(language)==[?].id)>>'];
	
	var kindOptions = {"Color": "color", "Mostrar/Ocultar": "show"};
	var currentB = <<(materbooks.data.==(language)==[?].id)>>;
	var currentCharID = 0;
	var thisBook = books['b'+currentB];
	var amountChar = thisBook.characters.length;
	var thisCurrentBook = currentBook();
	thisCurrentBook.storyId = currentB;
	setcurrentBook(thisCurrentBook);

/*
	var defaultModelImg = [];
	for( var i=0; i<amountChar; i++ ){
		defaultModelImg.push({"chico": "==(MAT_cdn2)==default/"+currentB+"_"+i+"_chico.png","chica": "==(MAT_cdn2)==default/"+currentB+"_"+i+"_chica.png"});
	}
*/

	var protagonist = 0;
	$.each( thisBook.characters, function( index, value ){
		if( value.kind == "Protagonist" ) {
			protagonist = index;
		}
	});

	function selectCurrentControls(){
		$.each( currentChar().layers, function( index, value ){
		  if( value.show == "" ){
			$(".runProp[data-target='"+value.color.target+"'][data-fill='"+value.color.fill+"']").attr( 'checked', true);
			$("#"+index+"N").attr( 'checked', true);
		  }else if(value.show != "none" ){
			$(".runProp[data-target='"+value.color.target+"'][data-fill='"+value.color.fill+"']").attr( 'checked', true);
			$(".runProp[data-target='"+value.show+"']").attr( 'checked', true);
		  }
		});

		//$(".runProp:checked").each( function(i,v){
		//	$(this).parent().parent().parent().css("margin-left", "-"+($(this).parent().parent().prevAll().length-2)*66+"px");
		//});
	}
	function setLayers(){
		$(".character-wrapper").find(".character-layers").attr("data-layer","none");
		var i = 1;
		$.each( thisBook.characters[currentCharToCustom].option.modelo.chica, function( index, value ){
			$(".chica-wrapper").find(".layer-"+i).attr("data-layer",index);
			i++;
		});
		var i = 1;
		$.each( thisBook.characters[currentCharToCustom].option.modelo.chico, function( index, value ){
			$(".chico-wrapper").find(".layer-"+i).attr("data-layer",index);
			i++;
		});
	}
	function drawModel( model=currentChar() ){
		model.src = undefined;
		var thisGender = model.gender_origin;
		if( model != false ) {
			$("."+thisGender+"-wrapper").find(".layer-0").children("img").attr("src","https://admin.materlu.com/books/"+currentB+"/layer_json/"+currentCharID+"/"+thisGender+"/background.png");
			$.each( model.layers, function( index, value ){
				if(  index == "piel" ){
					var color = "e7bfa5";
					if( typeof(value.color) != "undefined" && typeof(value.color.fill) != "undefined" && value.color.fill != "" ) color = value.color.fill;
					$(".chica-wrapper").find("[data-layer='"+index+"']").children("img").attr("src","https://admin.materlu.com/books/"+currentB+"/layer_json/"+currentCharID+"/chica/o_"+index+color+".png");
					$(".chico-wrapper").find("[data-layer='"+index+"']").children("img").attr("src","https://admin.materlu.com/books/"+currentB+"/layer_json/"+currentCharID+"/chico/o_"+index+color+".png");
				}else if(  value.show == "None" || value.show == "none"  || value.show == "" ){
					$("."+thisGender+"-wrapper").find("[data-layer='"+index+"']").children("img").attr("src","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=");
				}else{
					var color = "";
					if( typeof(value.color) != "undefined" && typeof(value.color.fill) != "undefined" && value.color.fill != "" ) color = value.color.fill;
					$("."+thisGender+"-wrapper").find("[data-layer='"+index+"']").children("img").attr("src","https://admin.materlu.com/books/"+currentB+"/layer_json/"+currentCharID+"/"+thisGender+"/o_"+value.show+color+".png");
				}
			});
			model.src = "https://admin.materlu.com/api/avatar?storyId="+currentB+"&characterNo="+(currentCharToCustom+1)+"&param="+window.btoa(JSON.stringify( model ));
			newChar( model );
		}
		$(".previewChars").addClass("showChars");
	}
	function selectOption(item){
		if ( currentChar() == false ){
			newChar( defaultModel[currentGender] );
		}
		//	addToCurrentChar(gender,name,layer,type,jsonItem)
		addToCurrentChar(item.gender,item.gender_origin,item.name,item.layer,item.type,item.jsonItem);
		drawModel();
	}
	function endCharacter(){
		var name = $("#character_name").val();
		var currentC = currentChar();
		currentC.name = name;
		currentC.position = currentCharToCustom;
		newChar(currentC);
		addCurrentChar();
		addCurrentCharToCurrentBook(currentCharToCustom);/* << -- */
		addBreadcrumpChar();
		$(".charName"+currentCharToCustom).text(name);
		$(".lastName").text(name);
		
		if( amountChar < currentBook().characters.length ){
			let curBk = currentBook();
			curBk.characters.splice(amountChar, 1);
			addTocurrentBook(curBk);
			window.location.assign("==(MAT_url_dedicatory)==");
		}
		else if( amountChar == currentBook().characters.length ){
			window.location.assign("==(MAT_url_dedicatory)==");
		}else{
			currentCharToCustom++;			
			currentCharID = thisBook.characters[currentCharToCustom].id;
			nextChar();
		}
		return;
	}

/* >> breadcrump*/
	function addBreadcrumpChar(){
		let cCharacters = currentBook().characters;
		if(cCharacters == undefined) return false;
		cCharacters.forEach(function(cObj, key){
			var src = "https://admin.materlu.com/api/avatar?storyId="+currentB+"&characterNo="+(key+1)+"&param="+window.btoa(JSON.stringify( cObj ));
			$('.charsBreadCurrent'+key).next().prop('src', src);
			$(".charName"+key).text(cObj.name[1]);
		})
	}
/* << end of breadcrump*/

	function nextChar(){
		$(".charsBreadCurrent").removeClass("d-none");
		$(".charsBreadCurrent"+currentCharToCustom).addClass("d-none");
		$("#character_name").val("");
		if( currentCharToCustom != 0 ) $(".moreCharacters").removeClass("d-none");
		drawModel( defaultModel["chico"+currentCharToCustom] );
		newChar( defaultModel["chica"+currentCharToCustom] );
		setChica();	
		setLayers();
		drawModel();
		selectCurrentControls();
		$(".breadcrumb-selected").addClass("d-none");
		$(".charsBreadCurrent"+currentCharToCustom).removeClass("d-none");
	}
	function drawSaved(){
		var getList = getCharacters();
		var grupo = currentGenderChar.substr(0, currentGenderChar.length-1);
		if( getList[grupo] != undefined ){
			$(".savedCharacters").html("");
			$.each( getList[grupo], function( index, thisChar ){
				var div = ''
				+'<div class="col-xl-2 col-lg-3 col-sm-4 col-8 d-flex flex-column justify-content-end saved-character bg-gradient-light-2 rounded box-shadow-sm position-relative pt-2 px-1 my-sm-2 my-3 mx-2">'
				+	'<div class="saved-character-buttons position-absolute d-flex flex-row justify-content-end">'
				+		'<span class="mx-1 useThisChar" data-id="'+index+'" data-target="'+grupo+'"><i class="fas fa-pencil-alt"></i></span>'
				+		'<span class="mx-1 deleteChar" data-id="'+index+'" data-target="'+grupo+'"><i class="fas fa-trash"></i></span>'
				+	'</div>'
				+	'<div>'
				+		'<img src="'+thisChar.src+'" class="img-fluid object-fit-contain" alt="'+thisChar.name+'">'
				+		'<span class="breadcrumb-charactername d-flex justify-content-center useThisChar" data-id="'+index+'" data-target="'+grupo+'">'+thisChar.name+'</span>'                    
				+	'</div>'
				+'</div>';
				$(".savedCharacters").append(div);
			});
		}
	}
	function loadFromSaved(item){
		currentGender = item.gender_origin;
		var thisGender = defaultModel[currentGender+currentCharToCustom].gender;
		item.gender = thisGender;
		currentGenderChar = thisGender;
		newChar(item);
		if( currentGender == "chico" ){
			setChico();
		}else{
			setChica();
		}
		drawModel();
		$("#character_name").val( item.name );
	}
	
	function setChica(){
		if ( currentGender == "chico"){
			newChar( defaultModel["chica"+currentCharToCustom] );
			drawModel();
		}
		$("#girl").prop( "checked", true );
		$("#boy").prop( "checked", false );
		currentGender = "chica";
		currentGenderChar = defaultModel["chica"+currentCharToCustom].gender;
		$(".chica-wrapper").removeClass("gender-deselected");          
		$(".chica-wrapper").addClass("gender-selected");
		$(".chico-wrapper").removeClass("gender-selected");   
		$(".chico-wrapper").addClass("gender-deselected");

		$(".solo-algo").addClass("d-none");
		if( currentGenderChar == "chica" || currentGenderChar == "amiga" ){
			$(".solo-chica").removeClass("d-none");
		}
		if( currentGenderChar == "adulta" ){
			$(".solo-adulta").removeClass("d-none");
		}
	}
	function setChico(){
		if ( currentGender == "chica"){
			newChar( defaultModel["chico"+currentCharToCustom] );
			drawModel();
		}
		$("#girl").prop( "checked", false );
		$("#boy").prop( "checked", true );
		currentGender = "chico";
		currentGenderChar = defaultModel["chico"+currentCharToCustom].gender;
		$(".chico-wrapper").removeClass("gender-deselected");
		$(".chico-wrapper").addClass("gender-selected");
		$(".chica-wrapper").removeClass("gender-selected");
		$(".chica-wrapper").addClass("gender-deselected");

		$(".solo-algo").addClass("d-none");
		if( currentGenderChar == "chico" || currentGenderChar == "amigo" ){
			$(".solo-chico").removeClass("d-none");
		}
		if( currentGenderChar == "adulto" ){
			$(".solo-adulto").removeClass("d-none");
		}
	}
	function editModel(id){
		var model = currentBook().characters[id];
		model.name = model.name[1];
		model.position = id;
		newChar(model);
		window.location.assign("==(MAT_url_customization)==");
	}
</script>